# Generated by Django 5.2.8 on 2025-12-02 10:35

import json
from django.db import migrations


def convert_richtext_to_streamfield(apps, schema_editor):
    BlogPage = apps.get_model("blog", "BlogPage")
    for page in BlogPage.objects.all():
        if page.body:
            # Convert RichTextField content to StreamField JSON format
            # Wrap existing rich text in a paragraph block
            stream_data = [{"type": "paragraph", "value": str(page.body)}]
            page.body = json.dumps(stream_data)
            page.save(update_fields=['body'])


def convert_streamfield_to_richtext(apps, schema_editor):
    BlogPage = apps.get_model("blog", "BlogPage")
    for page in BlogPage.objects.all():
        if page.body:
            try:
                # Extract text from first paragraph block if it exists
                stream_data = json.loads(page.body) if isinstance(page.body, str) else page.body
                if isinstance(stream_data, list) and len(stream_data) > 0:
                    first_block = stream_data[0]
                    if isinstance(first_block, dict) and first_block.get("type") == "paragraph":
                        page.body = first_block.get("value", "")
                    else:
                        page.body = ""
                else:
                    page.body = ""
            except (json.JSONDecodeError, TypeError):
                page.body = ""
            page.save(update_fields=['body'])


class Migration(migrations.Migration):

    dependencies = [
        ("blog", "0002_blogpage"),
    ]

    operations = [
        migrations.RunPython(convert_richtext_to_streamfield, convert_streamfield_to_richtext),
    ]

